## 获得Web服务器的IP地址

回顾一下我们上一步做了些什么。上一步中，我们其实只完成了一件事情，那就是配置“Internet 协议版本 4（TCP/IPv4）属性”，仅此而已。通俗地说，我们只是填写了本机的IP地址、默认网关、子网掩码、本地DNS服务器。

接下来，我们需要访问一个网页，访问网页其实就是访问一个Web服务器，从Web服务器上取回要访问的页面。我们从浏览器中输入网址，假设需要访问我的主页，我们会在地址栏中输入域名（www.jannchie.xin）。在网络中，域名只是为了让人们便于记忆罢了，能够起到定位作用的是服务器的IP地址。我们前面提到DNS域名系统就是存放这种域名和IP的映射关系的数据库。因此，输入完域名敲下回车后，便进行DNS查询。要知道之前我们只是设定了本地DNS服务器的地址而已，真正对DNS服务的运用现在才开始。

### 发送DNS查询

前面已经提到DNS缓存。也就是本地DNS服务器能够缓存之前查到的域名地址映射关系，所有访问该DNS服务器的主机首先会去访问检索缓存，如果有所要查的条目（在本例中，即为www.jannchie.xin与其IP的映射条目），则直接返回IP，如果没有，则需要逐层对域名进行解析。解析过程如下：

首先，我们本地DNS服务器向根DNS服务器发出DNS查询，这是一条UDP查询报文。

然而即使时发送这条信息过程也颇为坎坷。首先一般来说，本地DNS服务器说是本地，但却并不是在我们的主机上的。确切地说，本地DNS服务器甚至于主机不在一个网段内。这意味着向本地DNS服务器发送消息还需要穿过网关路由。而且另一方面，在IP地址下方，还有一个地址，叫做MAC地址，或者称之为物理地址。要让发送的信息被指定的主机接收，必须要知道对方的物理地址，很可惜，刚接入互联网的我们对此一无所知。而ARP（地址解析协议）正是为了这个而存在的。

### ARP：地址解析协议

地址解析协议 (ARP) 是通过解析网路层地址来找寻数据链路层地址的一个在网络协议包中极其重要的网络传输协议。 

>在以太网协议中规定，同一局域网中的一台主机要和另一台主机进行直接通信，必须要知道目标主机的MAC地址。而在TCP/IP协议中，网络层和传输层只关心目标主机的IP地址。这就导致在以太网中使用IP协议时，数据链路层的以太网协议接到上层IP协议提供的数据中，只包含目的主机的IP地址。于是需要一种方法，根据目的主机的IP地址，获得其MAC地址。这就是ARP协议要做的事情。所谓地址解析（address resolution）就是主机在发送帧前将目标IP地址转换成目标MAC地址的过程。[摘自维基]

#### ARP查询过程

具体来说，我们现在的目标是获得网关路由的MAC地址，而现在我们拥有的是网关路由的IP地址，我们首先发送一个ARP广播报文，其中自然包括自身的MAC地址和IP地址的信息，除此之外，目的MAC地址填FF:FF:FF:FF:FF:FF,而IP地址填网关路由的IP。这个报文会被所有的主机捕获，这个过程相当于这个主机在整个网段里喊：“我是XXX，我想要知道这个IP地址对应的MAC地址，如果知道的话就告诉我！”。

这段话被其他主机听到后，他们查看目的IP地址，如果主机发现目的IP不是自己的IP，则会丢弃之，而网关路由收到发现目的IP是自己的IP，则会返回ARP响应报文，由于他知道发送方的MAC，所以可以单播地（一对一地）发送给请求MAC地址的主机，也就是发出请求的我们。

### DNS查询过程

接下来，要发送DNS查询给本地DNS服务器，把自己的IP与该服务器IP按位与，发现不在一个网段内，则转给网关路由让其转发，最终该请求发送到了本地DNS服务器。

接下来，本地DNS服务器进行DNS查询，它首先向一个根域名服务器其中198.41.0.4是一个根域名服务器IP地址。根域名服务器注意到该域名是.xin结尾的，因此返回xin顶级域DNS服务器的地址。

之后出现两种情况，如果发出的DNS查询期望递归查询，那么将会由根域名服务器向xin顶级域服务器发送DNS查询报文，查询的结果也会先返回给根域名服务器。但一般使用迭代查询，在这种情况下，根域名服务器会把结果返回给本地DNS服务器，本地DNS服务器再向xin顶级域名服务器发送DNS查询报文。

xin顶级域名服务器注意到.jannchie.xin，于是返回包含这一信息的权威DNS服务器给本地DNS服务器。

本地DNS服务器再向权威DNS服务器发送查询，最终返回了www.jannchie.xin该域名对应的Web服务器的IP地址。

接着就可以建立与该服务器的TCP链接了。
## 目录

- [准备接入网络](#%E5%87%86%E5%A4%87%E6%8E%A5%E5%85%A5%E7%BD%91%E7%BB%9C)
- [IP：网际协议](#ip%EF%BC%9A%E7%BD%91%E9%99%85%E5%8D%8F%E8%AE%AE)
    - [IPv4](#ipv4)
    - [IPv6](#ipv6)
    - [从IPv4到IPv6](#%E4%BB%8Eipv4%E5%88%B0ipv6)
    - [子网](#%E5%AD%90%E7%BD%91)
    - [子网掩码](#%E5%AD%90%E7%BD%91%E6%8E%A9%E7%A0%81)
    - [子网划分](#%E5%AD%90%E7%BD%91%E5%88%92%E5%88%86)
- [DHCP：动态主机配置协议](#dhcp%EF%BC%9A%E5%8A%A8%E6%80%81%E4%B8%BB%E6%9C%BA%E9%85%8D%E7%BD%AE%E5%8D%8F%E8%AE%AE)
- [NAT：网络地址转换](#nat%EF%BC%9A%E7%BD%91%E7%BB%9C%E5%9C%B0%E5%9D%80%E8%BD%AC%E6%8D%A2)
- [DNS：域名系统](#dns%EF%BC%9A%E5%9F%9F%E5%90%8D%E7%B3%BB%E7%BB%9F)
    - [分布式](#%E5%88%86%E5%B8%83%E5%BC%8F)
    - [层次](#%E5%B1%82%E6%AC%A1)
    - [DNS缓存](#dns%E7%BC%93%E5%AD%98)
    - [DNS记录](#dns%E8%AE%B0%E5%BD%95)
- [准备好了咩](#%E5%87%86%E5%A4%87%E5%A5%BD%E4%BA%86%E5%92%A9)

## 准备接入网络

现在，在学校中，我拥有一台笔记本电脑，要怎么让它联网呢？即使没有学过计算机网络的知识也知道，我们只需要插上一根网线，再填上IP地址、子网掩码、默认网关、DNS服务器等，就完成了联网的第一步。

那么，IP地址究竟应该怎么填，子网掩码究竟是什么意思，默认网关又代表了什么呢？

在这里涉及到的第一个协议，就是网际协议（IP）。

### IP：网际协议

比起网际协议，IP这两个字母更加为人熟知。IP是网际协议（Internet Protocol）的缩写。IP协议是网络层的协议。目前所使用的IP协议有两个版本，分别为IPv4和IPv6。IPv6是未来的趋势。

---

#### IPv4

IP地址这个词没有人会觉得陌生，对于IPv4而言，一般的表示方式为被三个点隔开的四个数字，如123.45.6.7。这种表示方法被称为是**点分十进制记法**。而实际上，IP地址的长度为32比特。

在全球因特网中的每一台主机与路由器的每一个接口都拥有一个唯一的IP地址。如果你需要获得一个IP地址，如果在windows中配置过IP地址，它会告诉我们，我们需要从“网络系统管理员”那里获取一个IP地址。一般来说，校园网也算作是一个ISP（互联网服务提供商），我们曾经按照公寓和住宿床位号在网络中心官网上查询。

如你所见，IPv4的地址只是32比特的二进制数，数量虽多但也有限。解决这个问题的办法有两个，一种是使用NAT，这一部分在下面进行讨论。还有一种是换用IPv6协议。

#### IPv6

IPv6的地址有128比特，理论上在可以预见的未来，IPv6地址不会用尽，“地球上的每一个砂砾都可以用IPv6地址寻址”。IPv6的数据报结构也比IPv4简单，去除了很多实际中没有使用的字段。此外，还增加了**流标签**字段。流标签可以给不同的数据加上不同的优先级。

#### 从IPv4到IPv6

之前有提到，计算机的分层结构能够提高整个体系的可维护性，在某一层进行更改不会影响到其他层。但是对于如此庞大的全球范围的系统而言，即使改变一个层次的协议使用也是非常困难的。虽然IPv4早该入土为安，但是现实中我们较多使用的还是IPv4，从IPv4切换到IPv6也并没有那么简单。

现如今，我们需要把原来的IPv4结点切换到IPv6结点，使用的一种方式是使用**双栈**。也就是说一个结点同时能够运行两种协议。当IPv6的节点需要收到的IPv6数据报发送给IPv4，它需要把IPv6数据报转换成IPv4可识别的格式。这样做比较简单，缺点是会损失一些IPv6独有的字段。

还有一种方法叫做**建隧道**。说得通俗一些，还是上述的情况，IPv6的节点会将整个数据报打包进一个IPv4数据报中，通过中间又IPv4节点连接的隧道后，在接收的一段，IPv6节点能够识别出收到的这个IPv4数据报里面包了个IPv6数据报，它再取出其中的IPv6数据报进行发送，就可以获取IPv6的所有数据。

虽然说IPv6是未来的方向，但是鉴于目前更为广泛使用的是IPv4，所以我们之后的所有讨论一般都是基于IPv4的。

---

IP协议有一个重要的概念——子网。

#### 子网

IP地址数量虽然不够用，但也非常非常地多，它们并不是毫无关联毫无组织的。IP地址可以一切为二，分成两部分，前半部分叫**网络地址**，后半部分为**主机地址**。

Internet组织机构定义了五种IP地址，有A、B、C三类地址。

>**A类IP地址**：用可变的7位（bit）来标识网络号，可变的24位标识主机号，最前面一位为"0"，即A类地址的第一段取值介于1～126之间。A类地址通常为大型网络而提供，全世界总共只有126个A类网络，每个A类网络最多可以连接16777214台主机。

>**B类IP地址**：用可变的14位来标识网络号，可变的16位标识主机号，前面两位是"10"。B类地址的第一段取值介于128～191之间(网络号不能以数字127开头，数字127是专门保留给诊断用的，如127.0.0.1是回送地址，用于回路测试），第一段和第二段合在一起表示网络号。B类地址适用于中等规模的网络，全世界大约有16000个B类网络，每个B类网络最多可以连接65534台主机。

>**C类IP地址**：用可变的21位来标识网络号，可变的8位标识主机号，前面三位是"110"。C类地址的第一段取值介于192～223之间，第一段、第二段、第三段合在一起表示网络号。最后一段标识网络上的主机号。C类地址适用于校园网等小型网络，每个C类网络最多可以有254台主机。

除此之外还有D类和E类。

还需要注意的是，有一部分IP地址是不能使用的，而不能使用的IP地址还能分为好几种,包括私有地址、广播地址等。

其中**广播地址**的主机字段通常全为1(二进制)，而32位全为1的255.255.255.255属于受限广播,它不被路由发送，但会被送到相同物理网络段上的所有主机，非常常用。

而**私有地址**只能在局域网出现的地址。常见的有10.x.x.x，192.168.x.x。

#### 子网掩码

而子网掩码是用来区分网络地址和主机地址的。子网掩码同样是32比特，一般的形式是数个二进制的1跟着数个二进制的0。如果我们需要得到网络地址，我们只需要将子网掩码与IP地址相与即可，运算完毕之后得到的地址就是网络地址。

#### 子网划分

首先我们需要理解为什么存在子网划分。由上所述，如若不划分，按照A、B、C三类网络分配IP，那么假如咱们学校需要500个IP，我们发现C类的IP对我们太小了（C类网络最多254台主机），那么我们只能去使用B类。但是B类的网络能连接65534台主机，这又造成了严重的浪费。

而通过对子网的划分，我们可以分出511个IP供我们使用。

我们使用子网掩码进行划分。拿校园网举例，学校ISP获得了123.45.67.0/24的地址块，如果我们需要把它分成两个大小相同的部分，只要改变子网掩码即可。

这里用二进制来看更加容易理解：

原先的地址块为123.45.67.0/24（01111011 00101101 01000011 00000000）

原先的子网掩码为255.255.255.0（11111111 11111111 11111111 00000000）

等分后变成了123.45.67.128/23（01111011 00101101 01000011 10000000）

和128.45.67.0/23（01111011 00101101 01000011 00000000）

子网掩码都是255.255.255.128（11111111 11111111 11111111 10000000）。

子网划分的原则是先分大的，再分小的。并且子网的判断遵循最长匹配原则。

---

### DHCP：动态主机配置协议

现在我们基本回顾了IP协议，但只有一个IP协议还不够。考虑到填写IP地址是非常非常麻烦的，在大型的网络中填写分配服务器也是一件非常无聊的事情，而且考虑到我们所使用的是笔记本电脑，每当把一台电脑搬到别的地方，换到另一个子网的接入点时，我们需要重新输入IP，这也是非常不合理的。因此我们需要动态地配置主机的IP地址，这里所使用的就是DHCP协议。

事实上，现在的IP地址一般都不需要手动去填写，而是由DHCP服务器生成的。大多数路由器自带一个DHCP服务器。

DHCP协议一共有四个步骤：

1. **DHCP服务器发现**：新连接的主机通过67号端口，发送一个DHCP发现报文来寻找该网段内的DHCP服务器地址。新连接的电脑显然并不知道DHCP的地址，所以它会发送一个IP为255.255.255.255的广播包。而源地址则设置为0.0.0.0。
2. **DHCP服务器提供**：DHCP服务器收到了发现报文，返回一个DHCP提供报文。由于此时新连接的电脑还没有分配IP，所以依旧需要以广播的形式发送。该报文包括可被分配的IP供主机使用。该报文还包括IP地址租用期，包含分配的IP的有效时间。
3. **DHCP请求**：主机收到提供报文，发送DHCP请求报文，正式请求IP的分配。
4. **DHCP ACK**：DHCP服务器响应该请求，分配IP地址。

---

### NAT：网络地址转换

这个所谓的NAT网络地址转换常与DHCP联用。NAT是一个位于网关的代理协议。顺便一说，**默认网关**之前没有提到，它一般是指与外网 链接的路由或服务器的地址。前面提到，NAT可以解决IPv4地址不够用的问题。要了解具体是怎么解决，我们首先需要知道IP地址存在着一些私有地址，比如10.0.0.0/8。每个NAT的内网中的主机都使用这些IP地址。自然在一个内网中，IP地址是不能重复的。然而不同的内网却可以有两台主机拥有相同的IP地址。之所以有这种操作就是因为NAT的存在。

NAT顾名思义，通过维护一个**NAT转换表**，将内网向外发送内网数据包的私有IP地址和端口转换为公网IP和一个端口。相当于NAT接收一个包，然后自己把这个包转发出去，通过NAT能够对外屏蔽内网的细节，对于外部而言，所有这些包都是NAT发出的。因此完全可以做到多个主机发送的包经过NAT网络地址转换后，变为相同IP发送的数据包。

于是，NAT可以解决IP地址不够用的问题。只要分配给NAT一个IP地址，NAT就可以构建子网，接管数量可观的主机。而至于NAT怎么给内网分配IP地址，就是DHCP的工作了。

---

### DNS：域名系统

最后，我们只剩下了DNS需要回顾了。DNS提供的服务很简单，简单的说，就是将服务器的IP地址与域名绑定起来。

DNS服务使用的端口号为53。主机通过该端口发送DNS查询报文，然后等待DNS响应报文回复一个IP地址即可，同样由53号端口接收。

DNS通过维护一个巨庞大的分布式层次数据库来提供服务。

#### 分布式

分布式不用多说，没有一个成熟的系统会把所有鸡蛋放在一个篮子里，集中式DNS服务器的问题包括：

1. **单点故障**：此DNS服务器跪了，那么全世界的网页都打不开了。
2. **通信容量**：全世界的人都访问这个服务器，服务器炸了。
3. **远距离集中式数据库**：我在中国，访问一个中国的网站，还需要绕地球半圈圈，从位于美国的DNS服务器去取域名对应的IP，再绕半圈回来……
4. **维护**：此数据库维护全球的DNS信息，上亿的数据，还需要频繁删改查询。

#### 层次

而层次体现在DNS有不同的种类，实际上，DNS服务是一个树形的结构，根据所在层次的不同，分为三类：

- **根DNS服务器**：没有理解错的话，全世界13个集群，共247个。
- **顶级域（DNS）服务器**：负责如com（商用）、org（组织）、net（网络中心）、edu（教育）、gov（政府）等顶级域名以及cn、jp、us这种国家级域名。
- **权威DNS服务器**：各个组织、公司、学校自己维护的DNS服务器。

接下来出场的就是之前所需要填写的所谓**本地DNS服务器**了。虽然称之为本地服务器，但却并不是处在本地（毕竟我们都需要填一个IP了）。此服务器是ISP维护的，如果通过DHCP，那么将会自动获取最近的本地DNS服务器。本地DNS服务器起到了代理的作用，当主机发送DNS请求时会发向本地DNS服务器，本地服务器再去**递归**或是**迭代**地查询那些层次DNS服务器。

#### DNS缓存

一个DNS服务器下的所有主机每访问一个网站就要向DNS发起一次请求实在是太愚蠢了。DNS服务使用缓存是一件不言而喻的事情。当本地DNS服务器从一个DNS服务器中收到一个回答时，他能够缓存这个回答的信息，据说通常保存两天。如果另一个主机访问相同的网站向这个DNS服务器发出DNS请求，则会先从缓存中去寻找，免去了递归迭代查询的过程，大大减小了时延。

#### DNS记录

DNS记录是一个经常被忽视的部分。DNS服务器中存储的是资源记录RR，RR提供了主机名到IP的地址映射。每条资源记录包括Name、Value、Type、TTL四个字段。

TTL指的是缓存的过期时间，Type指定了条目的类型，也间接地指定了Name和Value指的是什么：

- Type = A => Name = 主机名，Value = IP地址
- Type = NS => Name = 域，Value = 知道如何获取此域IP的权威DNS主机名
- Type = CNAME => Name = 规范主机名，Value = 别名
- Type = MX => Name = 邮件服务器规范主机名，Value = 个别名

---

### 准备好了咩

现在，回顾完毕了应用层的DNS、网络层的IP协议、NAT协议、DHCP协议，我们终于能够大致了解接入互联网时大致的流程了。回到开始处，我们刚刚插入网线。然后，如果校园网不支持DHCP，我们需要手动配置IP地址、子网掩码、默认网关、和本地DNS服务器。

当然了，如果支持DHCP，那么就很舒服，插上网线就已经具备了联入网络的能力。所以说DHCP是一个好东西，让不懂计网的人也可以愉快地接入互联网，以后再也不会有这种：“你不是程序员么，我校园网连不上帮我接一下呗~”这种问题了！

好了，接下来，打开浏览器，我们就可以正式地通过网络，做更多的事情了。